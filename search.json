[{"title":"使用docker stack 搭建redis cluster","url":"http://mosasaur.cn/2017/08/16/使用docker-stack-搭建redis-cluster/","content":"<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>今天要使用docker搭建redis cluster,首先还是镜像，redis官方镜像表示玩不来啊，还是自定义吧</p>\n<h3 id=\"镜像制作\"><a href=\"#镜像制作\" class=\"headerlink\" title=\"镜像制作\"></a>镜像制作</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">FROM ubuntu:16.04</div><div class=\"line\">LABEL auther=<span class=\"string\">\"wuchenzhi\"</span></div><div class=\"line\">ADD kafka_2.10-0.10.0.1.tgz /opt/</div><div class=\"line\">ADD jdk-8u91-linux-x64.gz /usr/<span class=\"built_in\">local</span>/</div><div class=\"line\">RUN /bin/bash -c <span class=\"string\">'apt-get update;apt-get -y install vim'</span></div><div class=\"line\">ENV JAVA_HOME /usr/<span class=\"built_in\">local</span>/jdk1.8.0_91</div><div class=\"line\">ENV JRE_HOME <span class=\"variable\">$JAVA_HOME</span>/jre</div><div class=\"line\">ENV CLASSPATH <span class=\"variable\">$JAVA_HOME</span>/lib:<span class=\"variable\">$JRE_HOME</span>/lib</div><div class=\"line\">ENV PATH <span class=\"variable\">$PATH</span>:<span class=\"variable\">$JAVA_HOME</span>/bin:</div><div class=\"line\">WORKDIR /opt/kafka_2.10-0.10.0.1/</div><div class=\"line\">EXPOSE 9092</div><div class=\"line\">CMD [<span class=\"string\">\"/bin/bash\"</span>]</div></pre></td></tr></table></figure>\n<p>依然使用ubuntu镜像，安装redis，我们要使用stack模式来构建集群，更改下配置文件支持集群模式，编译需要gcc make，vim纯属个人爱好，redis cluster官方文档说到redis-trib.rb来构建集群，所以ruby rubygems，gem install redis也少不了，CMD个人喜欢/ban/bash,写compose_file再改</p>\n<p>redis.conf就贴个官方的吧，不过还需要关闭保护模式，或者添加bind，redis-trib无法访问<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">protected-mode no</div><div class=\"line\">port 6379</div><div class=\"line\">cluster-enabled yes</div><div class=\"line\">cluster-config-file nodes.conf</div><div class=\"line\">cluster-node-timeout 5000</div><div class=\"line\">appendonly yes</div></pre></td></tr></table></figure></p>\n<p>镜像就到这里吧，目前看来一切顺利</p>\n<h3 id=\"集群搭建\"><a href=\"#集群搭建\" class=\"headerlink\" title=\"集群搭建\"></a>集群搭建</h3><p>前面已经说到了使用docker stack进行集群部署，先写个compose_file<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">\"3\"</span></div><div class=\"line\"><span class=\"attr\">networks:</span></div><div class=\"line\"><span class=\"attr\">  net:</span></div><div class=\"line\"><span class=\"attr\">services:</span></div><div class=\"line\"><span class=\"attr\">  redis-trib:</span></div><div class=\"line\"><span class=\"attr\">    image:</span> wuchenzhi:redis</div><div class=\"line\"><span class=\"attr\">    deploy:</span></div><div class=\"line\"><span class=\"attr\">      replicas:</span> <span class=\"number\">1</span></div><div class=\"line\"><span class=\"attr\">      placement:</span></div><div class=\"line\"><span class=\"attr\">        constraints:</span></div><div class=\"line\"><span class=\"bullet\">          -</span> node.role == manager</div><div class=\"line\"><span class=\"attr\">    networks:</span></div><div class=\"line\"><span class=\"bullet\">      -</span> net</div><div class=\"line\"><span class=\"attr\">    command:</span> /opt/redis<span class=\"bullet\">-3.2</span><span class=\"number\">.10</span>/src/redis-server /opt/redis.conf</div><div class=\"line\"><span class=\"attr\">  redis1:</span></div><div class=\"line\"><span class=\"attr\">    image:</span> wuchenzhi:redis</div><div class=\"line\"><span class=\"attr\">    deploy:</span></div><div class=\"line\"><span class=\"attr\">      replicas:</span> <span class=\"number\">1</span></div><div class=\"line\"><span class=\"attr\">      placement:</span></div><div class=\"line\"><span class=\"attr\">        constraints:</span></div><div class=\"line\"><span class=\"bullet\">          -</span> node.role == manager</div><div class=\"line\"><span class=\"attr\">    networks:</span></div><div class=\"line\"><span class=\"bullet\">      -</span> net</div><div class=\"line\"><span class=\"attr\">    command:</span> /opt/redis<span class=\"bullet\">-3.2</span><span class=\"number\">.10</span>/src/redis-server /opt/redis.conf</div><div class=\"line\"><span class=\"attr\">  redis2:</span></div><div class=\"line\"><span class=\"attr\">    image:</span> wuchenzhi:redis</div><div class=\"line\"><span class=\"attr\">    deploy:</span></div><div class=\"line\"><span class=\"attr\">      replicas:</span> <span class=\"number\">1</span></div><div class=\"line\"><span class=\"attr\">      placement:</span></div><div class=\"line\"><span class=\"attr\">        constraints:</span></div><div class=\"line\"><span class=\"bullet\">          -</span> node.role == manager</div><div class=\"line\"><span class=\"attr\">    networks:</span></div><div class=\"line\"><span class=\"bullet\">      -</span> net</div><div class=\"line\"><span class=\"attr\">    command:</span> /opt/redis<span class=\"bullet\">-3.2</span><span class=\"number\">.10</span>/src/redis-server /opt/redis.conf</div><div class=\"line\"><span class=\"attr\">  redis3:</span></div><div class=\"line\"><span class=\"attr\">    image:</span> wuchenzhi:redis</div><div class=\"line\"><span class=\"attr\">    deploy:</span></div><div class=\"line\"><span class=\"attr\">      replicas:</span> <span class=\"number\">1</span></div><div class=\"line\"><span class=\"attr\">      placement:</span></div><div class=\"line\"><span class=\"attr\">        constraints:</span></div><div class=\"line\"><span class=\"bullet\">          -</span> node.role == manager</div><div class=\"line\"><span class=\"attr\">    networks:</span></div><div class=\"line\"><span class=\"bullet\">      -</span> net</div><div class=\"line\"><span class=\"attr\">    command:</span> /opt/redis<span class=\"bullet\">-3.2</span><span class=\"number\">.10</span>/src/redis-server /opt/redis.conf</div><div class=\"line\"><span class=\"attr\">  redis4:</span></div><div class=\"line\"><span class=\"attr\">    image:</span> wuchenzhi:redis</div><div class=\"line\"><span class=\"attr\">    deploy:</span></div><div class=\"line\"><span class=\"attr\">      replicas:</span> <span class=\"number\">1</span></div><div class=\"line\"><span class=\"attr\">      placement:</span></div><div class=\"line\"><span class=\"attr\">        constraints:</span></div><div class=\"line\"><span class=\"bullet\">          -</span> node.role == manager</div><div class=\"line\"><span class=\"attr\">    networks:</span></div><div class=\"line\"><span class=\"bullet\">      -</span> net</div><div class=\"line\"><span class=\"attr\">    command:</span> /opt/redis<span class=\"bullet\">-3.2</span><span class=\"number\">.10</span>/src/redis-server /opt/redis.conf</div><div class=\"line\"><span class=\"attr\">  redis5:</span></div><div class=\"line\"><span class=\"attr\">    image:</span> wuchenzhi:redis</div><div class=\"line\"><span class=\"attr\">    deploy:</span></div><div class=\"line\"><span class=\"attr\">      replicas:</span> <span class=\"number\">1</span></div><div class=\"line\"><span class=\"attr\">      placement:</span></div><div class=\"line\"><span class=\"attr\">        constraints:</span></div><div class=\"line\"><span class=\"bullet\">          -</span> node.role == manager</div><div class=\"line\"><span class=\"attr\">    networks:</span></div><div class=\"line\"><span class=\"bullet\">      -</span> net</div><div class=\"line\"><span class=\"attr\">    command:</span> /opt/redis<span class=\"bullet\">-3.2</span><span class=\"number\">.10</span>/src/redis-server /opt/redis.conf</div><div class=\"line\"><span class=\"attr\">  redis6:</span></div><div class=\"line\"><span class=\"attr\">    image:</span> wuchenzhi:redis</div><div class=\"line\"><span class=\"attr\">    deploy:</span></div><div class=\"line\"><span class=\"attr\">      replicas:</span> <span class=\"number\">1</span></div><div class=\"line\"><span class=\"attr\">      placement:</span></div><div class=\"line\"><span class=\"attr\">        constraints:</span></div><div class=\"line\"><span class=\"bullet\">          -</span> node.role == manager</div><div class=\"line\"><span class=\"attr\">    networks:</span></div><div class=\"line\"><span class=\"bullet\">      -</span> net</div><div class=\"line\"><span class=\"attr\">    command:</span> /opt/redis<span class=\"bullet\">-3.2</span><span class=\"number\">.10</span>/src/redis-server /opt/redis.conf</div></pre></td></tr></table></figure></p>\n<p>运行docker stack deploy -c redis-cluster.yaml redis-cluster，现在我们有6个redis1-6 server，和一个redis trib，目前6个redis实例独立运行，并未形成集群。现在我们进入redis trib容器，运行/redis-trib.rb create –replicas redis{1-6}:6379。应该就大功告成了，然而，并不是redis.trib居然不能解析hostname…必须写ip port，好吧再写个脚本获取ip，然后运行</p>\n<h3 id=\"结尾\"><a href=\"#结尾\" class=\"headerlink\" title=\"结尾\"></a>结尾</h3><p>前面只是测通了整个redis cluster,如果要直接deploy时就完成集群，需要更改redis trib，添加depend_on redis{1-6}，然后更改启动脚本获取ip后，运行create命令 </p>\n","categories":[],"tags":["Docker","Redis"]},{"title":"基于ubuntu官方镜像构建JDK+Tomcat镜像","url":"http://mosasaur.cn/2017/08/15/基于ubuntu官方镜像构建JDK-Tomcat镜像/","content":"<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>今天基于ubuntu16.04官方镜像使用Dockerfile制作JDK+Tomcat镜像，之前一直在看DOCKER DOSC，今天第一次开始实际操作，还是踩了不少的坑。</p>\n<h3 id=\"吹逼中\"><a href=\"#吹逼中\" class=\"headerlink\" title=\"吹逼中\"></a>吹逼中</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">FROM ubuntu:16.04</div></pre></td></tr></table></figure>\n<p>这个就不用多说了<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">LABEL auther=<span class=\"string\">\"wuchenzhi\"</span></div></pre></td></tr></table></figure></p>\n<p>自己写的Dockerfile还是署个名吧，这里使用标签，官方的意思是尽量使用LABEL，不要再使用MAINTAINER了，那就LABEL吧！<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">ADD jdk-8u91-linux-x64.gz /usr/<span class=\"built_in\">local</span>/</div><div class=\"line\">ADD apache-tomcat-8.5.6.tar.gz /usr/<span class=\"built_in\">local</span>/</div></pre></td></tr></table></figure></p>\n<p>使用ADD的时候就遇到坑了，可能是自己官方文档看得不仔细，一开始我把压缩文件ADD到/usr/local后，还使用RUN tar 试图解压文件，但build时报错，文件不存在，回去仔细看文档才发现，ADD命令会自动解压其能识别的压缩方式，后来想想也是，如果需要手动解压，那还需要再手动删除，太麻烦，docker帮我们干了<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">RUN /bin/bash -c <span class=\"string\">'apt-get update;apt-get -y install vim'</span></div></pre></td></tr></table></figure></p>\n<p>RUN 在Linux上默认使用/bin/sh 部分命令还是不能运行的，个人倾向使用/bin/bash<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">ENV JAVA_HOME /usr/<span class=\"built_in\">local</span>/jdk1.8.0_91</div><div class=\"line\">ENV JRE_HOME <span class=\"variable\">$JAVA_HOME</span>/jre</div><div class=\"line\">ENV CLASSPATH <span class=\"variable\">$JAVA_HOME</span>/lib:<span class=\"variable\">$JRE_HOME</span>/lib</div><div class=\"line\">ENV PATH <span class=\"variable\">$PATH</span>:<span class=\"variable\">$JAVA_HOME</span>/bin:</div><div class=\"line\">ENV TOMCAT_HOME /usr/<span class=\"built_in\">local</span>/apache-tomcat-8.5.6</div></pre></td></tr></table></figure></p>\n<p>ENV 是很好用的，它不光能在Dockerfile生效，还能生效于镜像所生成的容器实例（之前还想着RUN 来修改…）<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">EXPOSE 8080</div><div class=\"line\">CMD [<span class=\"string\">\"/bin/bash\"</span>]</div></pre></td></tr></table></figure></p>\n<h3 id=\"DOCKERFILE\"><a href=\"#DOCKERFILE\" class=\"headerlink\" title=\"DOCKERFILE\"></a>DOCKERFILE</h3><p>最后来个完整的Dockerfile，我的第一篇博文就算结束了，不是很满意，以后回来再改过<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">FROM ubuntu:16.04</div><div class=\"line\">LABEL auther=<span class=\"string\">\"wuchenzhi\"</span></div><div class=\"line\">ADD jdk-8u91-linux-x64.gz /usr/<span class=\"built_in\">local</span>/</div><div class=\"line\">ADD apache-tomcat-8.5.6.tar.gz /usr/<span class=\"built_in\">local</span>/</div><div class=\"line\">RUN /bin/bash -c <span class=\"string\">'apt-get update;apt-get -y install vim'</span></div><div class=\"line\">ENV JAVA_HOME /usr/<span class=\"built_in\">local</span>/jdk1.8.0_91</div><div class=\"line\">ENV JRE_HOME <span class=\"variable\">$JAVA_HOME</span>/jre</div><div class=\"line\">ENV CLASSPATH <span class=\"variable\">$JAVA_HOME</span>/lib:<span class=\"variable\">$JRE_HOME</span>/lib</div><div class=\"line\">ENV PATH <span class=\"variable\">$PATH</span>:<span class=\"variable\">$JAVA_HOME</span>/bin:</div><div class=\"line\">ENV TOMCAT_HOME /usr/<span class=\"built_in\">local</span>/apache-tomcat-8.5.6</div><div class=\"line\">EXPOSE 8080</div><div class=\"line\">CMD [<span class=\"string\">\"/bin/bash\"</span>]</div></pre></td></tr></table></figure></p>\n","categories":[],"tags":["Docker","Linux"]},{"title":"category","url":"http://mosasaur.cn/category/index.html","content":"","categories":[],"tags":[]},{"title":"about","url":"http://mosasaur.cn/about/index.html","content":"","categories":[],"tags":[]},{"title":"search","url":"http://mosasaur.cn/search/index.html","content":"","categories":[],"tags":[]},{"title":"project","url":"http://mosasaur.cn/project/index.html","content":"","categories":[],"tags":[]},{"title":"tag","url":"http://mosasaur.cn/tag/index.html","content":"","categories":[],"tags":[]},{"title":"link","url":"http://mosasaur.cn/link/index.html","content":"","categories":[],"tags":[]}]